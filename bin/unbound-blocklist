#!/bin/env sh

# Check if running with root privileges
if [ "$EUID" -ne 0 ]; then
  echo "Root permissions are required to run this script. (os error 13)"
  exit 13
fi

# Apply all of the blocklists to the policies directory.
echo "Downloading all of the blocklists and apply some fixes to make them compatible with the Unbound syntax."
echo -e "server:\n" | tee /etc/unbound/policies/*-blocklist.conf

# Download and apply blocklists
curl -s https://raw.githubusercontent.com/PeterDaveHello/url-shorteners/master/list | awk '/^[^#]/ { print "local-zone: \"" $1 "." "\" always_null" }' >> /etc/unbound/policies/url-shorteners-blocklist.conf
curl -s https://raw.githubusercontent.com/r-a-y/mobile-hosts/master/AdguardMobileAds.txt | awk '/^[^#]/ { print "local-zone: \"" $2 "." "\" always_null" }' >> /etc/unbound/policies/mobile-blocklist.conf
curl -s http://sbc.io/hosts/alternates/porn-only/hosts | awk '/^[^#]/ { print "local-zone: \"" $2 "." "\" always_null" }' >> /etc/unbound/policies/nsfw-blocklist.conf
curl -s https://raw.githubusercontent.com/hagezi/dns-blocklists/main/hosts/ultimate.txt | awk '/^[^#]/ { print "local-zone: \"" $2 "." "\" always_null" }' >> /etc/unbound/policies/hegazi-blocklist.conf
curl -s https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/huawei | awk '/^[^#]/ { print "local-zone: \"" $1 "." "\" always_null" }' >> /etc/unbound/policies/huawei-blocklist.conf
curl -s https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/windows | awk '/^[^#]/ { print "local-zone: \"" $1 "." "\" always_null" }' >> /etc/unbound/policies/windows-blocklist.conf
curl -s https://raw.githubusercontent.com/nextdns/native-tracking-domains/main/domains/apple | awk '/^[^#]/ { print "local-zone: \"" $1 "." "\" always_null" }' >> /etc/unbound/policies/apple-blocklist.conf
#curl -s https://raw.githubusercontent.com/nextdns/dns-bypass-methods/main/encrypted-dns | awk '/^[^#]/ { print "local-zone: \"" $1 "." "\" always_null" }' >> /etc/unbound/policies/encrypted-blocklist.conf
#curl -s https://raw.githubusercontent.com/nextdns/dns-bypass-methods/main/proxies | awk '/^[^#]/ { print "local-zone: \"" $1 "." "\" always_null" }' >> /etc/unbound/policies/proxies-blocklist.conf
#curl -s https://raw.githubusercontent.com/nextdns/dns-bypass-methods/main/vpn | awk '/^[^#]/ { print "local-zone: \"" $1 "." "\" always_null" }' >> /etc/unbound/policies/vpn-blocklist.conf

# Create the whitelist to whitelist some graph components of facebook that are required to run facebook.
echo "Creating a whitelist to whitelist graph components of facebook: *graph.facebook.com"
echo -e 'server:\n\nlocal-zone: "graph.facebook.com." transparent' > /etc/unbound/policies/whitelist.conf
echo 'local-zone: "b-graph.facebook.com." transparent' >> /etc/unbound/policies/whitelist.conf
echo 'local-zone: "graph.instagram.com." transparent' >> /etc/unbound/policies/whitelist.conf
echo -e 'server:\n\nlocal-zone: "gateway.local." redirect' > /etc/unbound/policies/rewrites.conf
echo 'local-data: "gateway.local. A 10.5.1.1"' >> /etc/unbound/policies/rewrites.conf
echo 'local-zone: "temu.com." always_null' > /etc/unbound/policies/rewrites.conf

# Restart Unbound
killall unbound; unbound
